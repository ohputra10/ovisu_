import { clearLine } from 'readline';
import websocket, { IMessageEvent} from 'websocket'
var w3cwebsocket = websocket.w3cwebsocket;

var client = new w3cwebsocket('ws://182.92.127.131:6041/rest/ws');


function wsStatus(){
    console.log("open:"+client.OPEN)
    console.log("connecting:"+client.CONNECTING)
    console.log("closing:"+client.CLOSED)
    console.log("close:"+client.CLOSING)
}
wsStatus();
client.onopen = function () {
    console.log("w3cWebSocket connected")
    console.log(client.readyState)
    client.send('{"action":"conn","args":{"req_id":0,"user":"root","password":"taosdata","db":"test"}}');
    client.send('{"action":"query","args":{"req_id":1,"sql":"select * from test.meters"}}')
    client.send('{"action":"fetch","args":{"req_id":1,"id":1}}')
    client.send('{"action":"fetch_block","args":{"req_id":1,"id":1}}')
    client.send('{"action":"free_result","args":{"req_id":1,"id":1}}')
    client.send('{"action": "version","args": {"req_id": 2,"id": 2}}')
}

client.onerror = function () {
    console.log("connect error")
}

client.onmessage = function (e: IMessageEvent) {
    console.log("data:"+e.data);
    console.log("")
    // console.log("instance of string:"+ (e.data instanceof String))
    // if( (typeof e.data)=='string')
    // {
    //     let message = JSON.parse(JSON.stringify(e.data))
    //     console.log(message);
    // }
    
}

client.onclose = function () {
    console.log("close")
}

console.log(client.readyState)

// function test() {
//     console.log(client.readyState)
//     var i =0;
//     while (true) {
//         console.log("times:",i,client.readyState);
//         i++;

//         if (client.readyState == client.OPEN) {
//             client.send('{"action":"conn","args":{"req_id":0,"user":"root","password":"taosdata","db":"test"}}');
//             break;
//         }
//     }
// }

// test();



function wsConnect(ws:websocket.w3cwebsocket, username:string,password:string,db?:string){
    const msg ={
        action:'conn',
        args:{
            req_id:0,
            user:username,
            password: password,
            db:db,
        }
    }
    ws.send(JSON.stringify(msg))

    // when response
}




setTimeout((() => client.close()), 2000);